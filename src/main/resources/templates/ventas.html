<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Ventas - Panadería</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #ffe5d9 0%, #fff1e6 40%, #fde2e4 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1f2937;
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 980px;
            margin: 2.5rem auto;
            padding: 0 1.25rem;
        }

        .main-card {
            background: #ffffff;
            border-radius: 20px;
            border: 2px solid #f4a261;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(156, 102, 68, 0.18);
        }

        .card-header {
            background: linear-gradient(90deg, #f4a261, #e76f51);
            padding: 1.5rem 2rem;
            border-bottom: none;
        }

        .page-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: #fffaf3;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .page-title i {
            font-size: 1.7rem;
        }

        .card-body {
            padding: 2rem;
            background-color: #fffdf8;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #9c6644;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: #e76f51;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1.4fr auto auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #fff7f0;
            border-radius: 16px;
            border: 1px solid rgba(244, 162, 97, 0.6);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: #6d6875;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-control,
        .form-select {
            padding: 0.75rem 1rem;
            border: 1.5px solid #f4a261;
            border-radius: 10px;
            font-size: 1rem;
            background: #ffffff;
            color: #1f2937;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: #e76f51;
            box-shadow: 0 0 0 0.15rem rgba(231, 111, 81, 0.25);
        }

        #cantidadInput {
            width: 90px;
        }

        .btn-add {
            background: linear-gradient(45deg, #f4a261, #e76f51);
            color: #fffaf3;
            border: none;
            padding: 0.8rem 1.6rem;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(231, 111, 81, 0.4);
            white-space: nowrap;
        }

        .btn-add:hover {
            filter: brightness(1.05);
            box-shadow: 0 6px 18px rgba(231, 111, 81, 0.6);
            color: #ffffff;
        }

        .products-section {
            margin-top: 2rem;
        }

        /* Tabla del carrito */
        .table-wrapper {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(244, 162, 97, 0.4);
            background-color: #fffdf8;
            margin-top: 1rem;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .products-table thead {
            background: linear-gradient(90deg, #f4a261, #e76f51);
            color: #fffaf3;
        }

        .products-table th {
            padding: 0.9rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: none;
        }

        .products-table td {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid #f3e1d0;
            color: #1f2937;
        }

        .products-table tr:last-child td {
            border-bottom: none;
        }

        .products-table tr:hover {
            background: #fff1e6;
        }

        .cart-item {
            background: #ffffff;
        }

        .btn-remove {
            background-color: #ffb703;
            color: #ffffff;
            border: none;
            padding: 0.45rem 1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove:hover {
            filter: brightness(1.05);
        }

        .total-section {
            text-align: right;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .total-amount {
            font-size: 1.6rem;
            font-weight: 700;
            color: #9c6644;
            margin-bottom: 1.2rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
        }

        .btn-back {
            background-color: #fff7f0;
            color: #9c6644;
            border: 2px solid #f4a261;
            padding: 0.7rem 1.5rem;
            border-radius: 20px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: auto;
        }

        .btn-back:hover {
            background-color: #f4a261;
            text-decoration: none;
            color: #fffaf3;
        }

        .btn-clear {
            background: #e63946;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-clear:hover {
            background: #c52833;
        }

        .btn-process {
            background: #52b788;
            color: #ffffff;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(82, 183, 136, 0.4);
        }

        .btn-process:hover {
            background: #40916c;
        }

        .btn-back-header {
            background-color: #fff7f0;
            color: #9c6644;
            border: 2px solid #f4a261;
            padding: 0.55rem 1.2rem;
            border-radius: 20px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .btn-back-header:hover {
            background-color: #f4a261;
            color: #fffaf3;
            text-decoration: none;
        }

        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: #6d6875;
            background-color: #fff7f0;
            border-radius: 16px;
            border: 1px dashed rgba(244, 162, 97, 0.7);
            margin-top: 0.5rem;
        }

        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #f4a261;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            #cantidadInput {
                width: 100%;
            }

            .products-table {
                font-size: 0.85rem;
            }

            .products-table th,
            .products-table td {
                padding: 0.75rem 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-back {
                margin-right: 0;
                margin-bottom: 0.5rem;
                justify-content: center;
            }

            .btn-clear,
            .btn-process {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 class="page-title">
                <i class="fas fa-cash-register"></i>
                Simular Venta
            </h1>

            <a href="/principal" class="btn-back-header">
                <i class="fas fa-home me-1"></i> Menú Principal
            </a>
        </div>

        <div class="card-body">
            <div class="section-title">
                <i class="fas fa-plus-circle"></i>
                Añadir Producto a la Venta
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Buscar y seleccionar un producto...</label>
                    <select class="form-select" id="productoSelect">
                        <option value="">Seleccione un producto</option>
                        <option th:each="p : ${productos}"
                                th:value="${p.id}"
                                th:text="${p.nombre}"
                                th:data-precio="${p.precio}"
                                th:data-stock="${p.stock}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="cantidadInput" value="1" min="1">
                </div>

                <button type="button" class="btn-add" onclick="agregarAlCarrito()">
                    <i class="fas fa-plus"></i>
                    Añadir al Carrito
                </button>
            </div>

            <div class="products-section">
                <div class="section-title">
                    <i class="fas fa-shopping-basket"></i>
                    Productos en el Carrito
                </div>

                <div id="cartContainer">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p><strong>Tu carrito está vacío</strong></p>
                        <p>Añade productos para comenzar una venta</p>
                    </div>
                </div>

                <div class="table-wrapper" id="cartTableWrapper" style="display: none;">
                    <table class="products-table" id="cartTable">
                        <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="width: 12%;">Cantidad</th>
                            <th style="width: 18%;">Precio Unitario</th>
                            <th style="width: 18%;">Subtotal</th>
                            <th style="width: 14%;">Acción</th>
                        </tr>
                        </thead>
                        <tbody id="cartItems">
                        </tbody>
                    </table>
                </div>

                <div class="total-section" id="totalSection" style="display: none;">
                    <div class="total-amount">
                        Total Venta: $<span id="totalAmount">0.00</span>
                    </div>

                    <div class="action-buttons">
                        <a href="/principal" class="btn-back">
                            <i class="fas fa-arrow-left"></i>
                            Volver
                        </a>
                        <button type="button" class="btn-clear" onclick="limpiarCarrito()">
                            <i class="fas fa-trash"></i>
                            Limpiar Carrito
                        </button>
                        <button type="button" class="btn-process" onclick="realizarVenta()">
                            <i class="fas fa-credit-card"></i>
                            Realizar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let carrito = [];
    let contadorId = 1;

    function agregarAlCarrito() {
        const select = document.getElementById('productoSelect');
        const cantidad = parseInt(document.getElementById('cantidadInput').value);

        if (!select.value) {
            alert('Por favor selecciona un producto');
            return;
        }

        if (!cantidad || cantidad < 1) {
            alert('Por favor ingresa una cantidad válida');
            return;
        }

        const option = select.options[select.selectedIndex];
        const productoId = select.value;
        const nombreProducto = option.text;
        const precio = parseFloat(option.dataset.precio);
        const stock = parseInt(option.dataset.stock);

        // Verificar stock
        if (cantidad > stock) {
            alert(`Stock insuficiente. Disponible: ${stock} unidades`);
            return;
        }

        // Verificar si el producto ya está en el carrito
        const productoExistente = carrito.find(item => item.productoId === productoId);

        if (productoExistente) {
            const nuevaCantidad = productoExistente.cantidad + cantidad;
            if (nuevaCantidad > stock) {
                alert(`Stock insuficiente. Ya tienes ${productoExistente.cantidad} en el carrito. Máximo disponible: ${stock}`);
                return;
            }
            productoExistente.cantidad = nuevaCantidad;
            productoExistente.subtotal = productoExistente.cantidad * precio;
        } else {
            carrito.push({
                id: contadorId++,
                productoId: productoId,
                nombre: nombreProducto,
                cantidad: cantidad,
                precio: precio,
                subtotal: cantidad * precio
            });
        }

        actualizarCarrito();

        // Limpiar formulario
        select.value = '';
        document.getElementById('cantidadInput').value = 1;
    }

    function removerDelCarrito(id) {
        carrito = carrito.filter(item => item.id !== id);
        actualizarCarrito();
    }

    function actualizarCarrito() {
        const cartContainer = document.getElementById('cartContainer');
        const cartTableWrapper = document.getElementById('cartTableWrapper');
        const cartItems = document.getElementById('cartItems');
        const totalSection = document.getElementById('totalSection');
        const totalAmount = document.getElementById('totalAmount');

        if (carrito.length === 0) {
            cartContainer.style.display = 'block';
            cartTableWrapper.style.display = 'none';
            totalSection.style.display = 'none';
            return;
        }

        cartContainer.style.display = 'none';
        cartTableWrapper.style.display = 'block';
        totalSection.style.display = 'block';

        // Limpiar tabla
        cartItems.innerHTML = '';

        // Agregar items
        let total = 0;
        carrito.forEach(item => {
            const row = document.createElement('tr');
            row.classList.add('cart-item');
            row.innerHTML = `
                <td>${item.nombre}</td>
                <td>${item.cantidad}</td>
                <td>$${item.precio.toFixed(2)}</td>
                <td>$${item.subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn-remove" onclick="removerDelCarrito(${item.id})">
                        Quitar
                    </button>
                </td>
            `;
            cartItems.appendChild(row);
            total += item.subtotal;
        });

        totalAmount.textContent = total.toFixed(2);
    }

    function limpiarCarrito() {
        if (carrito.length === 0) return;

        if (confirm('¿Estás seguro de que quieres limpiar el carrito?')) {
            carrito = [];
            actualizarCarrito();
        }
    }

    function realizarVenta() {
        if (carrito.length === 0) {
            alert('El carrito está vacío');
            return;
        }

        const total = carrito.reduce((sum, item) => sum + item.subtotal, 0);
        const resumen = carrito.map(item =>
            `${item.nombre} (${item.cantidad} x $${item.precio.toFixed(2)})`
        ).join('\n');

        const confirmacion = confirm(
            `¿Confirmar venta?\n\n${resumen}\n\nTotal: $${total.toFixed(2)}`
        );

        if (confirmacion) {
            // Procesar cada item del carrito
            carrito.forEach(item => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/ventas/realizar';
                form.style.display = 'none';

                const inputProducto = document.createElement('input');
                inputProducto.name = 'productoId';
                inputProducto.value = item.productoId;
                form.appendChild(inputProducto);

                const inputCantidad = document.createElement('input');
                inputCantidad.name = 'cantidad';
                inputCantidad.value = item.cantidad;
                form.appendChild(inputCantidad);

                document.body.appendChild(form);
                form.submit();
            });
        }
    }
</script>
</body>
</html>